# ============================================================
# Logstash Configuration for CareDroid Logs
# Processes structured JSON logs from Winston logger and
# ingests them into Elasticsearch for centralized log analysis
# ============================================================

input {
  # Read from backend combined logs (daily rotated)
  file {
    path => "/logs/combined-*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["backend", "request"]
  }

  # Read from backend error logs (daily rotated)
  file {
    path => "/logs/errors-*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["backend", "error"]
  }

  # Read from exception handling logs
  file {
    path => "/logs/exceptions-*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["backend", "exception"]
  }

  # Read from unhandled rejection logs
  file {
    path => "/logs/rejections-*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["backend", "rejection"]
  }
}

filter {
  # Parse timestamps
  date {
    match => ["timestamp", "YYYY-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }

  # Parse request duration into milliseconds
  if [duration] {
    mutate {
      convert => {
        "duration" => "float"
      }
    }
  }

  # Parse status code into integer
  if [statusCode] {
    mutate {
      convert => {
        "statusCode" => "integer"
      }
    }
  }

  # Parse content length into integer
  if [contentLength] {
    mutate {
      convert => {
        "contentLength" => "integer"
      }
    }
  }

  # Add geoip information if IP is present
  if [ip] and [ip] != "127.0.0.1" and [ip] != "::1" {
    geoip {
      source => "ip"
      target => "geoip"
    }
  }

  # Add custom fields for easier filtering
  mutate {
    add_field => {
      "environment" => "${NODE_ENV:development}"
      "service" => "caredroid-backend"
      "version" => "1.0.0"
    }
  }

  # Flag slow requests for alerting (>2s)
  if [duration] and [duration] > 2000 {
    mutate {
      add_tag => ["slow_request"]
      add_field => {
        "performance_issue" => true
      }
    }
  }

  # Flag error responses (5xx)
  if [statusCode] and [statusCode] >= 500 {
    mutate {
      add_tag => ["server_error"]
    }
  }

  # Flag client errors (4xx)
  if [statusCode] and [statusCode] >= 400 and [statusCode] < 500 {
    mutate {
      add_tag => ["client_error"]
    }
  }
}

output {
  # Send to Elasticsearch with proper index naming
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Also output to stdout for Docker logs (useful for debugging)
  stdout {
    codec => rubydebug
  }
}
