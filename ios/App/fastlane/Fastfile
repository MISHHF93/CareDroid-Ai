# iOS Fastlane Configuration

default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  desc "Build release version"
  lane :build_release do
    increment_build_number(xcodeproj: "App.xcodeproj")
    
    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.caredroid.app" => "CareDroid Production"
        }
      },
      output_directory: "./build",
      output_name: "CareDroid.ipa"
    )
  end

  desc "Upload to TestFlight"
  lane :upload_testflight do
    upload_to_testflight(
      apple_id: ENV['FASTLANE_APPLE_ID'],
      app_identifier: "com.caredroid.app",
      skip_waiting_for_build_processing: true,
      changelog: "Bug fixes and performance improvements"
    )
  end

  desc "Deploy to App Store"
  lane :release do
    build_release
    
    upload_to_app_store(
      force: true,
      reject_if_possible: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: true,
      automatic_release: true,
      submission_information: {
        add_id_info_uses_idfa: false,
        export_compliance_uses_encryption: true,
        export_compliance_encryption_updated: false
      }
    )
  end

  desc "Take screenshots"
  lane :screenshots do
    capture_screenshots
    frame_screenshots(white: true)
    upload_to_app_store(
      skip_binary_upload: true,
      skip_metadata: false
    )
  end

  error do |lane, exception|
    notification(subtitle: "Error in #{lane}", message: exception.message)
  end
end
